rule gcp_credential_access_private_keys_exfiltration_correlation {
  meta:
    author = "Gowthaman"
    description = "Correlates SCC private key/password search findings with subsequent sensitive file downloads across GCP and Office 365"
    severity = "High"
    priority = "High"

  events:
    // Phase 1: SCC Credential Access Finding (GCP)
    $discovery_event.metadata.event_type = "STATUS_UPDATE"
    $discovery_event.metadata.log_type = "GCP_SECURITYCENTER_THREAT"
    $discovery_event.metadata.product_name = "Security Command Center"
    $discovery_event.metadata.product_event_type = "Credential Access: Search Private Keys or Passwords"
    $discovery_event.principal.hostname = $hostname
    $discovery_event.target.resource.name = $gcp_project_id
    $discovery_event.security_result.rule_name = $finding_type
    
    // Look for the specific private key search rule - use either product_event_type OR rule_name
    $discovery_event.security_result.rule_name = "ktd_search_private_keys_or_passwords"
    
    // Extract users from security_result.about.user.email_addresses
    $discovery_event.security_result.about.user.email_addresses = $user_email

    // Phase 2: File Download Activity (Office 365)
    $exfiltration_event.metadata.event_type = "USER_RESOURCE_UPDATE_CONTENT"
    $exfiltration_event.metadata.log_type = "OFFICE_365"
    $exfiltration_event.metadata.product_name = "Office 365"
    $exfiltration_event.metadata.product_event_type = "FileDownloaded"
    $exfiltration_event.principal.user.userid = $user_id
    $exfiltration_event.principal.user.email_addresses = $user_email
    $exfiltration_event.principal.ip = $source_ip
    
    // File download specific fields
    $exfiltration_event.src.file.full_path = $file_path
    $exfiltration_event.src.file.mime_type = $file_type
    $exfiltration_event.src.file.size = $file_size
    $exfiltration_event.src.url = $download_url
    
    // Target sensitive file patterns based on SCC finding
    (
        re.regex($exfiltration_event.src.file.full_path, ".*\\.(key|pem|pkcs8|pkcs12|p12|pfx|cer|crt|der|jks)$") or
        re.regex($exfiltration_event.src.file.full_path, ".*(id_rsa|id_rsa_enc|certKey\\.pem|key\\.pem|ssl\\.key|ssh_host_rsa_key|ssh_host_dsa_key|ssh_host_ecdsa_key).*") or
        re.regex($exfiltration_event.src.file.full_path, ".*(secret|password|credential|token|keystore).*") or
        re.regex($exfiltration_event.src.file.full_path, ".*(\\.env|\\.pwd|\\.secret|\\.token|\\.cred).*")
    )

    // Correlation conditions
    $exfiltration_event.metadata.event_timestamp.seconds >= $discovery_event.metadata.event_timestamp.seconds
    $exfiltration_event.metadata.event_timestamp.seconds - $discovery_event.metadata.event_timestamp.seconds <= 3600  // 1 hour

  match:
    $user_email over 2h

  outcome:
    // Fixed risk score calculation - no nested if statements
    $risk_score = max(
        // Base score based on SCC severity
        if($discovery_event.security_result.severity = "HIGH", 40,
          if($discovery_event.security_result.severity = "MEDIUM", 25, 15)) +
        // File type risk
        if(re.regex($file_path, ".*\\.(key|pem)$"), 30, 
          if(re.regex($file_path, ".*id_rsa.*"), 35, 20)) +
        // Timing risk
        if($exfiltration_event.metadata.event_timestamp.seconds - $discovery_event.metadata.event_timestamp.seconds <= 900, 20, 5) +
        // File size risk
        if($file_size > 1048576, 10, 0)
    )
    
    $compromised_user = array_distinct($user_email)
    $target_project = array_distinct($gcp_project_id)
    $source_host = array_distinct($hostname)
    $user_ip = array_distinct($source_ip)
    $discovery_time = array_distinct($discovery_event.metadata.event_timestamp.seconds)
    $exfiltration_time = array_distinct($exfiltration_event.metadata.event_timestamp.seconds)
    $finding_rule = array_distinct($finding_type)
    $downloaded_file = array_distinct($file_path)
    $file_size_bytes = array_distinct($file_size)
    $download_source = array_distinct($download_url)
    $time_to_exfiltration = array_distinct($exfiltration_event.metadata.event_timestamp.seconds - $discovery_event.metadata.event_timestamp.seconds)
    $scc_severity = array_distinct($discovery_event.security_result.severity)
    $user_agent = array_distinct($exfiltration_event.network.http.user_agent)

  condition:
    $discovery_event and $exfiltration_event
}
